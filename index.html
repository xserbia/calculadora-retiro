<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora de Retiro con Monte Carlo</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      margin: 0;
      background: #ffffff;
    }
    .container {
      max-width: 700px;
      margin: auto;
      padding: 0 10px;
    }
    h1 {
      color: #111827;
      text-align: center;
      font-size: 1.75rem;
    }
    label {
      display: block;
      margin: 16px 0 4px;
      font-weight: bold;
    }
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: pointer;
    }
    .tooltip::after {
      content: attr(data-tooltip);
      visibility: hidden;
      opacity: 0;
      width: 250px;
      background-color: #333;
      color: #fff;
      text-align: left;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 0;
      transform: translateX(-10%);
      transition: opacity 0.3s;
      font-size: 13px;
      line-height: 1.4;
    }
    .tooltip:hover::after {
      visibility: visible;
      opacity: 1;
    }
    input {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      padding: 14px;
      width: 100%;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      transition: background 0.3s;
    }
    button:hover {
      background: #1e40af;
    }
    .resultado-bloque {
      background-color: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-top: 24px;
      overflow-x: auto;
    }
    .resultado-bloque h2 {
      margin-bottom: 12px;
      color: #1f2937;
      font-size: 1.25rem;
    }
    .resultado-bloque table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    .resultado-bloque td {
      padding: 6px 0;
      vertical-align: top;
      font-size: 15px;
    }
    .resultado-bloque td:last-child {
      text-align: right;
      font-weight: 500;
      color: #1f2937;
    }
    #mensajeAlerta {
      display: none;
    }
    @media (max-width: 480px) {
      h1 {
        font-size: 1.5rem;
      }
      label {
        font-size: 15px;
      }
      input, button {
        font-size: 15px;
        padding: 12px;
      }
      .resultado-bloque td {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
<h1>Calculadora de Retiro con Monte Carlo <span class="tooltip" data-tooltip="Esta calculadora es solo para fines educativos y no constituye asesorÃ­a financiera, legal ni fiscal. Consulta a un profesional para recomendaciones personalizadas.">ğŸ›ˆ</span></h1>

    <label for="edadActual">Edad actual <span class="tooltip" data-tooltip="Tu edad actual hoy. Sirve como punto de partida para calcular los aÃ±os que faltan hasta tu retiro.">ğŸ›ˆ</span></label>
    <input type="number" id="edadActual" />

    <label for="edadRetiro">Edad de retiro <span class="tooltip" data-tooltip="La edad a la que planeas jubilarte. Determina cuÃ¡ntos aÃ±os de ahorro y de retiro tendrÃ¡s.">ğŸ›ˆ</span></label>
    <input type="number" id="edadRetiro" />

    <label for="vidaEsperada">Expectativa de vida <span class="tooltip" data-tooltip="Hasta quÃ© edad planeas que duren tus fondos. Puede ser tu esperanza de vida o mÃ¡s si deseas prevenir imprevistos.">ğŸ›ˆ</span></label>
    <input type="number" id="vidaEsperada" />

    <label for="ingreso">Ingreso anual actual <span class="tooltip" data-tooltip="Tu ingreso bruto anual actual. Se usa como base para calcular cuÃ¡nto necesitarÃ¡s en tu jubilaciÃ³n segÃºn el porcentaje de reemplazo.">ğŸ›ˆ</span></label>
    <input type="number" id="ingreso" />

    <label for="reemplazo">% de reemplazo <span class="tooltip" data-tooltip="Porcentaje de tu ingreso actual que deseas mantener al retirarte (ej. 70 significa 70% del ingreso actual).">ğŸ›ˆ</span></label>
    <input type="number" id="reemplazo" />

    <label for="seguro">Ingreso por pensiÃ³n o seguro social <span class="tooltip" data-tooltip="Monto anual adicional que recibirÃ¡s en tu jubilaciÃ³n, como pensiÃ³n o beneficios del seguro social.">ğŸ›ˆ</span></label>
    <input type="number" id="seguro" />

    <label for="tasaAcum">Tasa de acumulaciÃ³n (%) <span class="tooltip" data-tooltip="Rendimiento promedio anual esperado de tus inversiones durante los aÃ±os de ahorro.">ğŸ›ˆ</span></label>
    <input type="number" id="tasaAcum" />

    <label for="tasaRetiro">Tasa de retiro (%) <span class="tooltip" data-tooltip="Rendimiento promedio anual esperado de tus inversiones durante los aÃ±os de retiro.">ğŸ›ˆ</span></label>
    <input type="number" id="tasaRetiro" />

    <label for="inflacion">InflaciÃ³n esperada (%) <span class="tooltip" data-tooltip="Porcentaje de aumento de precios esperado por aÃ±o. Se usa para ajustar el valor del dinero en el tiempo.">ğŸ›ˆ</span></label>
    <input type="number" id="inflacion" />

    <label for="ahorroInicial">Ahorro inicial <span class="tooltip" data-tooltip="Monto que ya tienes ahorrado especÃ­ficamente para tu retiro.">ğŸ›ˆ</span></label>
    <input type="number" id="ahorroInicial" />

    <label for="ahorroAnual">Aporte anual <span class="tooltip" data-tooltip="Cantidad de dinero que planeas ahorrar cada aÃ±o hasta tu jubilaciÃ³n.">ğŸ›ˆ</span></label>
    <input type="number" id="ahorroAnual" />

    <button id="btnCalcular">Calcular</button>
    <button id="btnMonteCarlo">Simular con Monte Carlo</button>

    <div id="resultados">
      <div id="resumenCalculadora" class="resultado-bloque"></div>
      <div id="resultadoMonteCarlo" class="resultado-bloque"></div>
    </div>

    <div id="graficoThumbnail" style="margin-top: 16px; text-align: center;">
      <button id="btnToggleGrafico" style="padding: 10px 20px; font-size: 16px; border-radius: 6px; background: #2563eb; color: white; border: none;">ğŸ“ˆ Ver grÃ¡fico</button>
    </div>

    <div id="modalGrafico" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.6); z-index: 999; justify-content: center; align-items: center;">
      <div onclick="event.stopPropagation()" style="background: white; padding: 20px; border-radius: 12px; max-width: 90vw; max-height: 90vh; overflow: auto;">
        <div style="text-align: right;"><button id="cerrarModal" style="background: none; border: none; font-size: 18px; cursor: pointer;">âœ–</button></div>
        <canvas id="graficoMonteCarlo" height="400" width="600"></canvas>
      </div>
    </div>

    <div id="mensajeAlerta" class="resultado-bloque"></div>
<script>
const get = id => Number(document.getElementById(id).value);
let trayectorias = [];
let total_aÃ±os = 0;
let graficoYaDibujado = false;

document.getElementById("btnCalcular").addEventListener("click", calcularRetiro);
document.getElementById("btnMonteCarlo").addEventListener("click", simularMonteCarlo);

function calcularRetiro() {
  const edad_actual = get('edadActual');
  const edad_retiro = get('edadRetiro');
  const vida = get('vidaEsperada');
  const ingreso = get('ingreso');
  const reemplazo = get('reemplazo') / 100;
  const seguro = isNaN(get('seguro')) ? 0 : get('seguro');
  const tasa_acum = get('tasaAcum') / 100;
  const tasa_retiro = get('tasaRetiro') / 100;
  const inflacion = get('inflacion') / 100;
  const ahorro_inicial = get('ahorroInicial');
  const ahorro_anual = get('ahorroAnual');

  const campos = [edad_actual, edad_retiro, vida, ingreso, reemplazo, tasa_acum, tasa_retiro, inflacion, ahorro_inicial, ahorro_anual];
  if (campos.some(val => isNaN(val))) {
    mostrarAlerta("âŒ Verifica que todos los campos estÃ©n completos y vÃ¡lidos.");
    return;
  }
  if (edad_retiro <= edad_actual) {
    mostrarAlerta("âŒ La edad de retiro debe ser mayor que la edad actual.");
    return;
  }
  if (vida <= edad_retiro) {
    mostrarAlerta("âŒ La expectativa de vida debe ser mayor que la edad de retiro.");
    return;
  }
  if ([tasa_acum, tasa_retiro, inflacion].some(t => t < 0 || t > 1)) {
    mostrarAlerta("âŒ Las tasas deben estar entre 0% y 100%.");
    return;
  }
  if (reemplazo < 0 || reemplazo > 1) {
    mostrarAlerta("âŒ El porcentaje de reemplazo debe estar entre 0% y 100%.");
    return;
  }

  const aÃ±os_ahorro = edad_retiro - edad_actual;
  const aÃ±os_retiro = vida - edad_retiro;
  const ingresoHoy = ingreso * reemplazo + seguro;
  const ingresoFuturo = ingresoHoy * Math.pow(1 + inflacion, aÃ±os_ahorro);
  const tasa_real = (1 + tasa_retiro) / (1 + inflacion) - 1;
  const factor_ordinario = (1 - Math.pow(1 + tasa_real, -aÃ±os_retiro)) / tasa_real;
  const factor_anticipado = factor_ordinario * (1 + tasa_real);
  const capital = ingresoFuturo * factor_anticipado;
  const ahorroFuturo = ahorro_inicial * Math.pow(1 + tasa_acum, aÃ±os_ahorro);
  const aportes = ahorro_anual * ((Math.pow(1 + tasa_acum, aÃ±os_ahorro) - 1) / tasa_acum);
  const total = ahorroFuturo + aportes;
  const faltante = capital - total;
  const lump_sum = faltante > 0 ? faltante / Math.pow(1 + tasa_acum, aÃ±os_ahorro) : 0;

  let aporteAnualNecesario = 0;
  let aporteMensualNecesario = 0;
  if (faltante > 0) {
    aporteAnualNecesario = faltante * tasa_acum / (Math.pow(1 + tasa_acum, aÃ±os_ahorro) - 1);
    aporteMensualNecesario = aporteAnualNecesario / 12;
  }

  const resumen = `
    <h2>ğŸ§¾ Resultados calculados</h2>
    <table>
      <tr><td>ğŸ§± <strong>Capital necesario:</strong></td><td>$${Number(capital.toFixed(2)).toLocaleString()}</td></tr>
      <tr><td>ğŸ’¼ <strong>Total acumulado estimado:</strong></td><td>$${Number(total.toFixed(2)).toLocaleString()}</td></tr>
      <tr><td>âš ï¸ <strong>Faltante actual (lump sum):</strong></td><td>${lump_sum > 0 ? "$" + Number(lump_sum.toFixed(2)).toLocaleString() : "Meta alcanzada"}</td></tr>
      <tr><td>ğŸ’¸ <strong>Aporte anual recomendado extra:</strong></td><td>${aporteAnualNecesario > 0 ? "$" + Number(aporteAnualNecesario.toFixed(2)).toLocaleString() + "/aÃ±o" : "No requerido"}</td></tr>
      <tr><td>ğŸ’° <strong>Aporte mensual recomendado extra:</strong></td><td>${aporteMensualNecesario > 0 ? "$" + Number(aporteMensualNecesario.toFixed(2)).toLocaleString() + "/mes" : "No requerido"}</td></tr>
    </table>`;

  document.getElementById('resumenCalculadora').innerHTML = resumen;
  document.getElementById('mensajeAlerta').style.display = 'none';
}

function simularMonteCarlo() {
  const edad_actual = get('edadActual');
  const edad_retiro = get('edadRetiro');
  const vida = get('vidaEsperada');
  const ahorro_inicial = get('ahorroInicial');
  const ahorro_anual = get('ahorroAnual');
  const ingreso = get('ingreso');
  const reemplazo = get('reemplazo') / 100;
  const seguro = isNaN(get('seguro')) ? 0 : get('seguro');

  const boton = document.getElementById("btnMonteCarlo");
  boton.disabled = true;
  boton.textContent = "ğŸ”„ Calculando...";

  const campos = [edad_actual, edad_retiro, vida, ingreso, reemplazo, ahorro_inicial, ahorro_anual];
  if (campos.some(val => isNaN(val))) {
    mostrarAlerta("âŒ Verifica que todos los campos estÃ©n completos y vÃ¡lidos.");
    boton.disabled = false;
    boton.textContent = "Simular con Monte Carlo";
    return;
  }
  if (edad_retiro <= edad_actual) {
    mostrarAlerta("âŒ La edad de retiro debe ser mayor que la edad actual.");
    boton.disabled = false;
    boton.textContent = "Simular con Monte Carlo";
    return;
  }
  if (vida <= edad_retiro) {
    mostrarAlerta("âŒ La expectativa de vida debe ser mayor que la edad de retiro.");
    boton.disabled = false;
    boton.textContent = "Simular con Monte Carlo";
    return;
  }
  if (reemplazo < 0 || reemplazo > 1) {
    mostrarAlerta("âŒ El porcentaje de reemplazo debe estar entre 0% y 100%.");
    boton.disabled = false;
    boton.textContent = "Simular con Monte Carlo";
    return;
  }

  const aÃ±os_ahorro = edad_retiro - edad_actual;
  const aÃ±os_retiro = vida - edad_retiro;
  total_aÃ±os = aÃ±os_ahorro + aÃ±os_retiro;
  const retiro_base = ingreso * reemplazo + seguro;

  const meanAcum = 0.07;
  const meanRetiro = 0.05;
  const stdDev = 0.12;
  const simulaciones = 10000;
  let exitos = 0;
  trayectorias = [];
  const muestrasParaGrafico = 10;

  for (let i = 0; i < simulaciones; i++) {
    let capital = ahorro_inicial;
    let trayectoria = [];
    for (let j = 0; j < aÃ±os_ahorro; j++) {
      const rendimiento = randomNormal(meanAcum, stdDev);
      capital = capital * (1 + rendimiento) + ahorro_anual;
      if (i < muestrasParaGrafico) trayectoria.push(capital);
    }
    let exito = true;
    for (let k = 0; k < aÃ±os_retiro; k++) {
      const rendimiento = randomNormal(meanRetiro, stdDev);
      capital = capital * (1 + rendimiento) - retiro_base;
      if (i < muestrasParaGrafico) trayectoria.push(capital);
      if (capital <= 0) {
        exito = false;
        break;
      }
    }
    if (i < muestrasParaGrafico) trayectorias.push({ data: trayectoria, exito });
    if (exito) exitos++;
  }

  const probabilidad = (exitos / simulaciones) * 100;
  document.getElementById('resultadoMonteCarlo').innerHTML = `
    <h2>ğŸ”„ SimulaciÃ³n Monte Carlo</h2>
    <table>
      <tr><td>ğŸ§ª <strong>Probabilidad de Ã©xito:</strong></td><td>${probabilidad.toFixed(1)}%</td></tr>
      <tr><td>ğŸ“Œ <strong>InterpretaciÃ³n:</strong></td><td>En ${probabilidad.toFixed(1)}% de los escenarios simulados, no te quedas sin dinero antes de los ${vida} aÃ±os.</td></tr>
    </table>`;

  boton.textContent = "âœ… Hecho";
  setTimeout(() => {
    boton.disabled = false;
    boton.textContent = "Simular con Monte Carlo";
  }, 1000);
  graficoYaDibujado = false;
}

function randomNormal(mean, stdDev) {
  let u = 0, v = 0;
  while (u === 0) u = Math.random();
  while (v === 0) v = Math.random();
  return mean + stdDev * Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

function dibujarGraficoMonteCarlo(trayectorias, totalAnios) {
  const ctx = document.getElementById("graficoMonteCarlo").getContext("2d");
  const labels = Array.from({ length: totalAnios }, (_, i) => `AÃ±o ${i + 1}`);
  const datasets = trayectorias.map(({ data, exito }) => ({
    label: exito ? 'âœ… Ã‰xito' : 'âŒ Fallo',
    data,
    fill: false,
    borderColor: exito ? 'rgba(34,197,94,0.8)' : 'rgba(239,68,68,0.8)',
    borderWidth: 1.5,
    tension: 0.1
  }));
  new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => `$${ctx.raw.toFixed(0).toLocaleString()}`
          }
        }
      },
      scales: {
        y: {
          ticks: {
            callback: value => `$${Number(value).toLocaleString()}`
          }
        }
      }
    }
  });
}

document.getElementById("btnToggleGrafico").onclick = () => {
  const modal = document.getElementById("modalGrafico");
  const visible = modal.style.display === "flex";
  const btn = document.getElementById("btnToggleGrafico");
  if (visible) {
    modal.style.display = "none";
    btn.textContent = "ğŸ“ˆ Ver grÃ¡fico";
  } else {
    modal.style.display = "flex";
    btn.textContent = "ğŸ”½ Ocultar grÃ¡fico";
    if (!graficoYaDibujado) {
      dibujarGraficoMonteCarlo(trayectorias, total_aÃ±os);
      graficoYaDibujado = true;
    }
  }
};

document.getElementById("modalGrafico").onclick = () => {
  document.getElementById("modalGrafico").style.display = "none";
  document.getElementById("btnToggleGrafico").textContent = "ğŸ“ˆ Ver grÃ¡fico";
};
document.getElementById("cerrarModal").onclick = () => {
  document.getElementById("modalGrafico").style.display = "none";
  document.getElementById("btnToggleGrafico").textContent = "ğŸ“ˆ Ver grÃ¡fico";
};

function mostrarAlerta(msg) {
  const alerta = document.getElementById('mensajeAlerta');
  alerta.textContent = msg;
  alerta.style.backgroundColor = '#fee2e2';
  alerta.style.color = '#991b1b';
  alerta.style.display = 'block';
}
</script>
</body>
</html>

